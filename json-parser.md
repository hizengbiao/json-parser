# JSON Parser 功能与场景说明文档

**文件路径**: `d:\projects\vibe-coding\dev-tools\json-parser.html`
**最新版本**: V1.69

本文档旨在全面梳理 JSON Parser 的现有功能和业务场景，以便在后续开发中进行回归测试，避免功能退化。

---

## 1. 界面布局 (UI Structure)

*   **单视图切换设计**:
    *   页面主要区域是一个通过 Tab 或按钮切换的视图容器 (`.editor-content`)。
    *   **源码模式 (Source View)**: (`#view-source`) 默认显示，包含一个大的文本输入框 (`textarea#json-input`)，用于粘贴和输入原始 JSON。
    *   **树状模式 (Tree View)**: (`#view-tree`) 格式化后显示，展示交互式的树状结构 (`#json-output`)。
    *   *注*: 两者互斥显示，通过底层的 `switchMode` 函数控制 `.active` 类进行切换，并非左右分栏。
*   **顶部工具栏**: 包含所有全局操作按钮（粘贴、格式化、编辑、压缩、修复、清空、撤销/重做等）。
*   **悬浮工具**:
    *   **Toast 提示**: 页面底部居中显示的临时提示信息。
    *   **路径提示**: 鼠标悬停在 Key 上时显示的全部层级路径。
    *   **版本/更新日志**: 顶部右侧的版本号，点击弹出模态框。

---

## 2. 核心功能 (Core Features)

### 2.1 格式化 (Format)
*   **触发方式**: 点击“⚡ 格式化”或粘贴并格式化。
*   **逻辑**:
    *   将输入框内的字符串解析为 JSON 对象。
    *   如果当前在 Tree 模式且数据被修改过 (`sourceDirty`)，则重新渲染树。
    *   渲染成功后切换到 Tree 视图。
*   **错误处理**: 解析失败时会在顶部显示醒目的红色错误提示框。

### 2.2 修复 (Fix Logic - 核心)
*   **触发方式**: 点击“🔧 修复”。
*   **逻辑流程** (`fixJson` 函数):
    1.  **预检查 (V1.66)**: 先尝试直接解析 (`JSON.parse`)。如果成功，说明是有效 JSON，直接格式化并提示“JSON 已有效”，**终止后续修复流程**（防止误伤有效内容）。
    2.  **注释去除**: 去除单行 (`//`) 和多行 (`/* */`) 注释。
    3.  **首尾清理**:
        *   去除首尾的逗号、句号。
        *   去除外层包裹的引号（如 `"..."` 或 `'...'`，如果内容被完整包裹）。
    4.  **标签去除 (V1.63)**:
        *   支持去除双括号标签：`[[TAG]]...[[/TAG]]`、`[[TAG]]...` 等。
        *   支持去除单括号标签：`[TAG]...[/TAG]`、`[TAG]...` 等。
        *   *正则细节*: 忽略大小写，支持只存在开始或结束标签的情况。
    5.  **二次首尾清理**: 去除标签后再次检查外层引号和首尾符号。
    6.  **冒号与数组修复 (V1.62)**: 调用 `fixChineseColons`:
        *   **中文冒号**: 将 `key ： value` 替换为 `key : value`。
        *   **无引号键**: 将 `key : value` 修复为 `"key": "value"`。
        *   **逗号分隔数字**: 将大数字字符串 `123,456` 自动转换为数组 `["123", "456"]`（防止大数精度丢失）。
        *   *智能跳过*: 跳过已经是标准 JSON 格式的行。
    7.  **转义处理**:
        *   去除反斜杠换行 (`\\\n`)。
        *   **JSON 字符串转义**: 如果内容包含 `\"`，尝试反转义（`\"` -> `"`, `\\` -> `\` 等）。
    8.  **JSONP 清理**: 去除 `callback(...)` 形式的包裹。
    9.  **缺失逗号补全 (V1.61)**: 调用 `addMissingCommas`，在换行分隔的键值对行末自动添加逗号。
    10. **自动加引号 (V1.60)**: 调用 `addQuotesToUnquotedStrings`，将 JS 对象字面量（`{name: 'abc'}`）转换为标准 JSON。
    11. **解析重试策略**:
        *   第一次尝试: `new Function("return " + raw)`（比 JSON.parse 更宽容）。
        *   第二次尝试: 包裹 `{...}` 后解析（处理裸键值对）。
        *   第三次尝试: 调用 `fixTruncatedJson` 修复截断内容后解析。
    12. **截断修复**:
        *   移除首尾不完整的键值对。
        *   补全缺失的闭合括号 (`]`, `}`) 或开始括号。

### 2.3 压缩 (Minify)
*   **触发方式**: 点击“📦 压缩”。
*   **逻辑**: 去除所有空白字符，输出紧凑的 JSON 字符串。
*   **特性**: 如果在 Tree 模式且有数据，压缩时保留当前的排序状态。

### 2.4 编辑源码 (Source Editor)
*   **触发方式**: 点击“✏️ 编辑”。
*   **同步逻辑 (V1.67)**: 进入编辑模式时，如果当前有解析对象 (`currentObj`)，会将 **格式化后（带缩进）** 的 JSON 同步到输入框，而不是显示原始输入。
*   **括号匹配 (V1.56/V1.64)**:
    *   支持 `()`, `[]`, `{}` 高亮。
    *   支持引号 `""`, `''` 配对高亮。
    *   点击括号/引号时显示橙红色脉冲动画。

### 2.5 树状视图交互 (Tree Interaction)
*   **节点操作**:
    *   **展开/收起**: 点击图标或双击括号/键名。
    *   **工具栏**: 提供“全部展开”、“全部收起”、“升序/降序”按钮。
*   **行号**: 显示绝对行号。
*   **快捷操作** (鼠标悬停显示):
    *   **复制**: 复制键、复制值、复制键值对。
    *   **新增属性**: 在对象/数组节点下新增。
        *   *逻辑*: 自动生成键名 `新属性1`, `新属性2` 等，默认值为字符串 `"新值"`。若为数组则直接 push `"新值"`。
    *   **折叠子树**: 输入深度 N，折叠 N 层以下的子树。
    *   **删除**: 删除当前节点。
    *   **编辑值**: 弹出多行文本框编辑整个子树或长文本。

---

## 3. 编辑交互细节 (Editing Logic)

### 3.1 键值编辑
*   **操作**: 点击 Key 或 Value 的文本内容进入编辑模式。
*   **自动全选 (V1.69)**: 点击编辑时，默认 `select()` 全选输入框内容。
*   **类型保持 (V1.65)**:
    *   若原值为字符串，编辑提交后**强制保持为字符串**。
    *   防止转义的 JSON 字符串（如 `"{\"a\":1}"`）被自动解析为对象。
*   **折叠保持 (V1.68)**: 编辑提交并重新渲染树时，记录并恢复所有节点的折叠/展开状态，避免视图重置。
*   **输入框自适应**: 宽度随内容自动伸缩，长文本自动切换为多行 (`textarea`)。

### 3.2 子树编辑
*   **操作**: 点击节点右侧“编辑值”。
*   **界面**: 弹出一个大的文本域，支持编辑复杂的 JSON 结构或长文本。
*   **智能同步**:
    *   小文件 (<1000行): 自动格式化并刷新树。
    *   大文件: 显示“已修改”预览块，需手动点击“格式化”按钮进行同步（优化性能）。
    *   **预览截断**: 若内容长度超过 **50,000 字符**，预览块中仅显示前 50,000 字并提示“内容过多，已截断预览”。

---

## 4. 其他功能 (Other Features)

### 4.1 Java 代码转换
*   **JSON 转 Java Bean**: 
    *   将 JSON 对象转换为对应的 Java 类定义。
    *   自动识别嵌套对象生成内部类。
    *   推断字段类型 (String, Integer, Double, Boolean, List<T>)。
    *   包含标准 Getter/Setter 方法和 Jackson `@JsonProperty` 注解。
*   **Java Bean 转 JSON**:
    *   解析简单的 Java 类定义字符串，提取字段名为 JSON Key。
    *   根据字段类型生成默认值（String="新值", Integer=86600, Boolean=false 等）。

### 4.2 撤销/重做
*   **快捷键**: 支持 `Ctrl+Z` (撤销) 和 `Ctrl+Y` (重做)。
*   **状态栈**: 每次修改（输入、粘贴、格式化、编辑、修复）都会保存当前源码到历史栈。

---

## 4. 测试用例场景 (Test Scenarios)

在修改代码后，请务必验证以下场景：

### 4.1 修复功能测试
1.  **标准修复**: `{'a':1, b: 2}` -> `{"a": 1, "b": 2}`
2.  **标签去除**: `[LOG]{"a":1}[/LOG]` -> `{"a": 1}`
3.  **中文冒号**: `{"k" ： "v"}` -> `{"k": "v"}`
4.  **无冒号键**: `key : value` -> `{"key": "value"}`
5.  **大数数组**: `ids: 1234567890123456789,9876543210987654321` -> `ids: ["...", "..."]`
6.  **转义保护 (V1.66)**: 输入 `{"msg": "{\"a\":1}"}`，点击修复。
    *   **预期**: 提示“JSON 已有效”，结果保持不变，**不**应该变成 `{"msg": {"a":1}}`（双重解析）。

### 4.2 编辑功能测试
1.  **字符串编辑**:
    *   输入 `{"data": "{\"id\":1}"}`。
    *   点击值 `"{\"id\":1}"` 进行编辑。
    *   修改为 `"{\"id\":2}"` 并回车。
    *   **预期**: 结果仍为字符串，显示为 `"{\"id\":2}"`，而**不是**变为对象 `{id: 2}`。
2.  **全选测试**:
    *   点击任意键或值进入编辑。
    *   **预期**: 内容应被全选（蓝色高亮）。
3.  **折叠保持**:
    *   展开一个深层树，手动折叠其中几个子节点。
    *   修改另一个兄弟节点的值。
    *   **预期**: 树刷新后，之前手动折叠的节点仍然保持折叠状态。
4.  **源码同步**:
    *   在树状视图修改值。
    *   点击顶部“编辑”切换回源码模式。
    *   **预期**: 源码框显示的是修改后且**格式化好**的 JSON。

### 4.3 括号/引号高亮
1.  在源码编辑框输入 `{"a": [1, 2]}`。
2.  点击 `[` 或 `]`，应高亮对应括号。
3.  点击 `"`，应高亮对应引号。

---

## 5. 版本更新记录摘要
*   **V1.69**: 编辑点击默认全选。
*   **V1.68**: 编辑后保持折叠状态。
*   **V1.67**: 切换编辑模式同步格式化内容。
*   **V1.66**: 修复功能前置检查（避免破坏有效JSON）。
*   **V1.65**: 编辑字符串保持类型（禁止自动反序列化）。
*   **V1.64**: 引号匹配高亮。
*   **V1.63**: 增强标签去除 (双括号/单括号)。
