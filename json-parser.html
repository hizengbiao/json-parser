<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="nav.css">
    <script src="nav.js" defer></script>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --panel-bg: #ffffff;
            --border-color: #d1d5db;
            --text-color: #333;
            --key-color: #cf222e;
            --string-color: #0a3069;
            --number-color: #0550ae;
            --boolean-color: #cf222e;
            --null-color: #6e7781;
            --preview-color: #8c959f;
            --gutter-bg: #f6f8fa;
            --gutter-color: #bbb;
            --hover-row: #fffbdd;
            --hover-path-bg: rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* Toolbar Styles */
        .main-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(27, 31, 35, 0.15);
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            background-color: #fff;
        }

        .btn-primary {
            background-color: #0969da;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0a58ca;
        }

        .btn-default:hover {
            background-color: #f3f4f6;
        }

        /* Layout */
        .container {
            display: flex;
            flex: 1;
            flex-direction: column;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            height: calc(100% - 80px);
            /* Adjust based on toolbar height */
        }

        /* Tabs */
        .tabs-header {
            display: flex;
            background: #f6f8fa;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            padding: 0 10px;
            height: 48px;
        }

        .tab-btn {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #57606a;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
        }

        .tab-btn:hover {
            color: #24292f;
            background: rgba(0, 0, 0, 0.02);
        }

        .tab-btn.active {
            color: #0969da;
            border-bottom-color: #0969da;
            background: #fff;
            /* Tab look */
            border-radius: 6px 6px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            margin-bottom: -1px;
            /* Overlap border */
            position: relative;
            z-index: 1;
        }

        .tab-spacer {
            flex: 1;
        }

        .tab-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Editor container */
        .editor-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Views */
        .view-panel {
            flex: 1;
            width: 100%;
            height: 100%;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            overflow: auto;
        }

        .view-panel.active {
            display: flex;
        }

        /* Source Code Editor */
        textarea#json-input,
        textarea#minified-output {
            flex: 1;
            width: 100%;
            border: none;
            padding: 15px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
            resize: none;
            outline: none;
            box-sizing: border-box;
            line-height: 1.5;
        }

        /* Tree Viewer Styles */
        .json-tree {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
            line-height: 1.6;
            width: 100%;
            padding: 10px 10px 10px 50px;
            /* Left padding for gutter */
            box-sizing: border-box;
            counter-reset: line;
            position: relative;
            /* Anchor for absolute line numbers */
        }

        .json-node {
            border-radius: 4px;
            transition: background-color 0.2s;
            padding-left: 5px;
            /* Ensure alignment between primitives and objects */
        }

        .json-node.object-node {
            margin: 3px 0;
            padding: 5px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background-color: transparent;
            /* position: relative; Removed to allow line-num to anchor to json-tree */
        }

        /* Dark mode adjustments if needed, though mostly using rgba opacity logic */

        .json-row {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            /* Center items vertically in the header */
            padding-left: 0;
            /* position: relative; Removed for gutter logic */
        }

        /* Line Numbers (Gutter) */
        .line-num {
            position: absolute;
            left: 5px;
            width: 35px;
            text-align: right;
            color: #6e7781;
            font-size: 12px;
            user-select: none;
            cursor: default;
        }

        .line-num::before {
            counter-increment: line;
            content: counter(line);
        }

        .json-node:hover>.json-row {
            /* Only highlight the header row of the current card, not the entire card content */
            background-color: transparent;
        }

        .json-node.object-node:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.2);
            background-color: rgba(0, 0, 0, 0.04);
            /* Highlight on hover (and bubbles to parents) */
        }

        .content-box {
            flex: 1;
            display: block;
            /* Wrapping */
            white-space: normal;
            word-break: break-all;
            line-height: 1.5;
            min-width: 0;
        }

        .json-children {
            width: 100%;
            padding-left: 10px;
            /* Structural indentation */
            padding-top: 2px;
            /* Optional guide line */
            margin-left: 2px;
            /* Align with guide line */
        }

        /* Collapsing */
        .json-node.collapsed .json-children {
            display: none;
        }

        .json-node.collapsed .close-bracket-row {
            display: none;
        }

        .json-node.collapsed .preview-text {
            display: inline-block;
        }

        .json-node.collapsed .collapsible-icon::after {
            content: "+";
        }

        .collapsible-icon {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            width: 14px;
            text-align: center;
            color: #57606a;
            margin-right: 2px;
            font-weight: bold;
        }

        .collapsible-icon::after {
            content: "-";
        }

        .collapsible-icon:hover {
            color: #0969da;
        }

        .preview-text {
            display: none;
            color: var(--preview-color);
            font-style: italic;
            cursor: pointer;
            user-select: none;
            margin: 0 5px;
            font-size: 12px;
            background: #f0f2f4;
            padding: 0 6px;
            border-radius: 4px;
        }

        .preview-text:hover {
            background: #e6e8eb;
            color: #333;
        }

        /* Syntax Highlighting */
        .key {
            color: var(--key-color);
            cursor: pointer;
        }

        .string {
            color: var(--string-color);
        }

        .number {
            color: var(--number-color);
        }

        .boolean {
            color: var(--boolean-color);
        }

        .null {
            color: var(--null-color);
            font-weight: bold;
        }

        .punctuation {
            color: #57606a;
        }

        /* Action Buttons */
        .action-group {
            opacity: 0;
            display: inline-flex;
            gap: 4px;
            margin-left: 10px;
            transition: opacity 0.1s;
            vertical-align: middle;
        }

        .json-row:hover .action-group {
            opacity: 1;
        }

        .tiny-btn {
            font-size: 11px;
            padding: 1px 6px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 3px;
            cursor: pointer;
            color: #57606a;
        }

        .tiny-btn:hover {
            border-color: #0969da;
            color: #0969da;
        }

        .icon-btn {
            border: none;
            background: none;
            cursor: pointer;
            color: #57606a;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .icon-btn:hover {
            background-color: #eaeef2;
            color: #0969da;
        }

        .icon-btn:disabled,
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /* Helpers */
        .hidden {
            display: none !important;
        }



        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #24292f;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 12px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .path-tooltip {
            position: fixed;
            background: #24292f;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: auto;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            border: 1px solid rgba(255, 255, 255, 0.1);
            user-select: none;
        }

        .path-segment {
            cursor: pointer;
            transition: all 0.2s;
            color: #58a6ff;
            padding: 0 2px;
            border-radius: 2px;
        }

        .path-segment:hover {
            background: rgba(88, 166, 255, 0.15);
            text-decoration: underline;
        }

        .path-copy-btn {
            font-size: 10px;
            color: #8b949e;
            margin-left: 12px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            display: inline-block;
        }

        .path-copy-btn:hover {
            background: #0969da;
            color: #fff;
        }

        .path-tooltip span.separator {
            color: #8b949e;
            margin: 0 4px;
            cursor: default;
        }

        .path-tooltip b {
            color: #58a6ff;
            font-weight: 500;
        }

        #error-msg {
            color: #cf222e;
            background: #ffebe9;
            padding: 10px;
            border: 1px solid #ff818266;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        /* Nav Bar */
        .nav-header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #d0d7de;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-item {
            text-decoration: none;
            color: #57606a;
            font-size: 14px;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 6px;
            transition: 0.2s;
        }

        .nav-item:hover {
            background-color: #f3f4f6;
            color: #24292f;
        }

        .nav-item.active {
            background-color: #0969da;
            color: white;
        }

        .edit-input {
            font-family: inherit;
            font-size: inherit;
            border: 1px solid #0969da;
            border-radius: 3px;
            padding: 0 4px;
            margin: 0;
            color: inherit;
            background: #fff;
            min-width: 100px;
            max-width: 100%;
            outline: none;
            box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.2);
            box-sizing: border-box;
            resize: none;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            line-height: inherit;
        }

        .subtree-editor-container {
            padding: 10px;
            background: #fff;
            border: 1px solid #0969da;
            border-radius: 6px;
            margin: 5px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .subtree-textarea {
            width: 100%;
            min-height: 200px;
            font-family: 'SFMono-Regular', Consolas, monospace;
            font-size: 13px;
            padding: 10px;
            border: 1px solid #d0d7de;
            border-radius: 4px;
            resize: vertical;
            outline: none;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .subtree-textarea:focus {
            border-color: #0969da;
            box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.2);
        }

        /* Version Info & Modal */
        .version-info {
            font-size: 12px;
            color: #6e7781;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            user-select: none;
            white-space: nowrap;
        }

        .version-info:hover {
            background: #eaeef2;
            color: #0969da;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: #fff;
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f6f8fa;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #24292f;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #57606a;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: 0.2s;
        }

        .close-modal:hover {
            background-color: #f3f4f6;
            color: #cf222e;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            color: #24292f;
            line-height: 1.6;
        }

        .changelog-date-group {
            margin-bottom: 30px;
        }

        .changelog-date {
            font-weight: 600;
            color: #24292f;
            font-size: 16px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #0969da;
            display: inline-block;
        }

        .changelog-entry {
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .changelog-version {
            font-weight: 700;
            color: #0969da;
            background: #ddf4ff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            min-width: 50px;
            text-align: center;
            margin-top: 2px;
        }

        .changelog-desc {
            color: #444;
            flex: 1;
        }
    </style>
</head>

<body>

    <div class="main-actions">
        <!-- Global Actions -->
        <button class="btn btn-default" onclick="pasteAndFormat()" title="ä»å‰ªè´´æ¿ç²˜è´´å¹¶æ ¼å¼åŒ–">ğŸ“‹ ç²˜è´´å¹¶æ ¼å¼åŒ–</button>
        <button class="btn btn-default" onclick="handleFormat()" title="æ ¼å¼åŒ–ä¸ºæ ‘çŠ¶è§†å›¾">âš¡ æ ¼å¼åŒ–</button>
        <button class="btn btn-default" onclick="showEditor()" title="ç¼–è¾‘æºç ">âœï¸ ç¼–è¾‘</button>
        <button class="btn btn-default" onclick="handleMinify()" title="å‹ç¼© JSON">ğŸ“¦ å‹ç¼©</button>
        <button class="btn btn-default" onclick="fixJson()" title="ä¿®å¤éæ ‡å‡† JSON">ğŸ”§ ä¿®å¤</button>
        <button class="btn btn-default" onclick="handleJavaConvert()" title="JSON ä¸ Java ä»£ç äº’è½¬">â˜• Json/Java äº’è½¬</button>
        <button class="btn btn-default" onclick="clearAll()" title="æ¸…ç©ºå†…å®¹">ğŸ§¹ æ¸…ç©º</button>
        <div style="width: 15px;"></div>
        <button class="btn btn-default" onclick="undo()" title="æ’¤é”€ (Ctrl+Z)">â†©ï¸ æ’¤é”€</button>
        <button class="btn btn-default" onclick="redo()" title="é‡åš (Ctrl+Y)">â†ªï¸ é‡åš</button>

        <!-- Tree Actions (Dynamic visibility) -->
        <div class="action-separator" style="width:1px; height:20px; background:#e1e4e8; margin:0 10px;"></div>
        <div id="tree-toolbar" style="display:flex; gap:5px;">
            <button class="icon-btn" onclick="copyCurrentContent()" id="btn-copy" title="å¤åˆ¶å†…å®¹">ğŸ“‹ å¤åˆ¶</button>
            <button class="icon-btn tree-only" onclick="toggleAll(true)" title="å…¨éƒ¨å±•å¼€">ğŸ“– å±•å¼€</button>
            <button class="icon-btn tree-only" onclick="toggleAll(false)" title="å…¨éƒ¨æ”¶èµ·">ğŸ“• æ”¶èµ·</button>
            <button class="icon-btn tree-only" onclick="sortJson(true)" title="æŒ‰Keyå‡åº">â¬‡ï¸ å‡åº</button>
            <button class="icon-btn tree-only" onclick="sortJson(false)" title="æŒ‰Keyé™åº">â¬†ï¸ é™åº</button>
        </div>
        <div class="version-info" onclick="showChangelog()" title="æŸ¥çœ‹ç‰ˆæœ¬æ›´æ–°è®°å½•">
            <span>V1.52</span>
            <span>â„¹ï¸</span>
        </div>
    </div>

    <div id="error-msg"></div>

    <div class="container">
        <!-- content -->
        <div class="editor-content">
            <!-- View 1: Source Input -->
            <div id="view-source" class="view-panel active">
                <textarea id="json-input" placeholder="è¯·åœ¨æ­¤ç²˜è´´ JSON..."></textarea>
            </div>

            <!-- View 2: Tree Output -->
            <div id="view-tree" class="view-panel">
                <div id="json-output" class="json-tree"></div>
            </div>
        </div>
    </div>

    <div id="toast">æç¤ºä¿¡æ¯</div>
    <div id="path-tooltip" class="path-tooltip"></div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸš€ ç‰ˆæœ¬æ›´æ–°è¯´æ˜</h3>
                <button class="close-modal" onclick="closeChangelog()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="changelog-date-group">
                    <div class="changelog-date">2026å¹´1æœˆ13æ—¥</div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.52</div>
                        <div class="changelog-desc">ä¿®å¤å¤§æ–‡ä»¶ä¸‹ç¼–è¾‘å¤æ‚å€¼åæ˜¾ç¤ºç©ºç™½çš„ Bugï¼šå¯¹è±¡/æ•°ç»„ç±»å‹æ˜¾ç¤ºé¢„è§ˆæç¤ºï¼Œå¼•å¯¼ç”¨æˆ·æ ¼å¼åŒ–æŸ¥çœ‹ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.51</div>
                        <div class="changelog-desc">å®Œå–„å­æ ‘ç¼–è¾‘å™¨æ™ºèƒ½æ ¼å¼åŒ–ï¼šå°æ–‡ä»¶ç¼–è¾‘åç›´æ¥é‡æ–°æ¸²æŸ“ï¼Œå¤§æ–‡ä»¶æ˜¾ç¤ºé¢„è§ˆå¹¶æç¤ºæ‰‹åŠ¨æ ¼å¼åŒ–ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.50</div>
                        <div class="changelog-desc">æ™ºèƒ½è‡ªåŠ¨æ ¼å¼åŒ–ï¼šå°äº 1000 è¡Œçš„ JSON ç¼–è¾‘åè‡ªåŠ¨æ ¼å¼åŒ–ï¼Œå¤§æ–‡ä»¶éœ€æ‰‹åŠ¨æ ¼å¼åŒ–ï¼Œæå‡æ€§èƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.49</div>
                        <div class="changelog-desc">ä¿®å¤åŒæ­¥ç¼–è¾‘é”®å€¼ Bugï¼šæäº¤æ—¶åŠ¨æ€è·å–æœ€æ–°è·¯å¾„ï¼Œé‡å‘½åé”®åè‡ªåŠ¨åŒæ­¥å­æ ‘ DOM è·¯å¾„ï¼Œå½»åº•è§£å†³æ•°æ®é‡å¤é—®é¢˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.48</div>
                        <div class="changelog-desc">ç¼–è¾‘äº¤äº’ç»ˆæä¼˜åŒ–ï¼šå•è¡Œå†…å®¹éšè¾“å…¥è‡ªåŠ¨å¢é•¿ï¼Œè¶…è¿‡ä¸€è¡Œæ—¶è‡ªåŠ¨æ¢è¡Œå¹¶è½¬ä¸ºå¤šè¡Œå¸ƒå±€ï¼ŒæŒ‰ Enter é”®å¯ç›´æ¥ä¿å­˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.47</div>
                        <div class="changelog-desc">å¤šè¡Œç¼–è¾‘å¢å¼ºï¼šå¯¹äºåŒ…å«æ¢è¡Œæˆ–è¶…é•¿æ–‡æœ¬çš„é”®å€¼ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºå¤šè¡Œæ–‡æœ¬æ¡†å¹¶è‡ªé€‚åº”é«˜åº¦ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.46</div>
                        <div class="changelog-desc">ç¼–è¾‘äº¤äº’ä¼˜åŒ–ï¼šç¼–è¾‘é”®å€¼æ—¶ï¼Œè¾“å…¥æ¡†å®½åº¦éšå†…å®¹è‡ªåŠ¨ä¼¸ç¼©ï¼Œè§£å†³é•¿æ–‡æœ¬æ˜¾ç¤ºä¸å…¨çš„é—®é¢˜ã€‚</div>
                    </div>
                </div>

                <div class="changelog-date-group">
                    <div class="changelog-date">2026å¹´1æœˆ12æ—¥</div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.45</div>
                        <div class="changelog-desc">ä¼˜åŒ–è·³è½¬å®šä½é€»è¾‘ï¼šå½“ç›®æ ‡çˆ¶çº§å…ƒç´ åœ¨å±å¹•å¤–æ—¶ï¼Œè‡ªåŠ¨ç¿»é¡µæ»šåŠ¨è‡³è¯¥å…ƒç´ å¯è§ä½ç½®ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.44</div>
                        <div class="changelog-desc">è§†è§‰ä¼˜åŒ–ï¼šæ‚¬æµ®çª—ä¸­çš„çˆ¶çº§å…ƒç´ è·¯å¾„ç»Ÿä¸€ä½¿ç”¨è“è‰²å­—ä½“æ ‡è¯†ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.43</div>
                        <div class="changelog-desc">è·¯å¾„æ‚¬æµ®çª—äº¤äº’å‡çº§ï¼šç‚¹å‡»å…·ä½“å±‚çº§å¯è·³è½¬å®šä½ï¼Œç‚¹å‡»â€œå¤åˆ¶æŒ‰é’®â€æ‰å¤åˆ¶å®Œæ•´è·¯å¾„ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.42</div>
                        <div class="changelog-desc">äº¤äº’ä¿®å¤ï¼šè§£å†³é¼ æ ‡ç§»åŠ¨åˆ°è·¯å¾„æ‚¬æµ®çª—æ—¶ï¼Œæ‚¬æµ®çª—è·Ÿéšç§»åŠ¨å¯¼è‡´æ— æ³•ç‚¹å‡»çš„é—®é¢˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.41</div>
                        <div class="changelog-desc">ä¿®å¤ä½¿ç”¨ç¼–è¾‘åŠŸèƒ½æ—¶çš„æ€§èƒ½å¡é¡¿é—®é¢˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.40</div>
                        <div class="changelog-desc">ä¿®å¤ç¼–è¾‘ä¿å­˜åé¡µé¢æ˜¾ç¤ºæ—§å€¼çš„é—®é¢˜ï¼›æ”¯æŒåŸæ ·å±•ç¤ºæœªæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²å†…å®¹ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.39</div>
                        <div class="changelog-desc">æ€§èƒ½ä¸ä½“éªŒä¼˜åŒ–ï¼šç¼–è¾‘å¤§æ–‡æœ¬ JSON æ—¶ï¼Œä¿å­˜åä¸å†è‡ªåŠ¨å…¨é‡æ ¼å¼åŒ–ï¼Œé¿å…å¡é¡¿ã€‚</div>
                    </div>
                </div>

                <div class="changelog-date-group">
                    <div class="changelog-date">2026å¹´1æœˆ7æ—¥</div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.38</div>
                        <div class="changelog-desc">ä¼˜åŒ– UI å¯¹é½ï¼šåŒä¸€å±‚çº§çš„ Keyã€å·¦æ‹¬å·ã€å³æ‹¬å·ä¿æŒå‚ç›´å¯¹é½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.37</div>
                        <div class="changelog-desc">æ–°å¢â€œç²˜è´´å¹¶æ ¼å¼åŒ–â€å¿«æ·åŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.36</div>
                        <div class="changelog-desc">æ›´æ–°é¡¹ç›®æè¿°æ–‡æ¡£ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.35</div>
                        <div class="changelog-desc">æ–°å¢ JSON ä¸ Java Bean äº’è½¬åŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.34</div>
                        <div class="changelog-desc">å®ç° JSON å­æ ‘æŠ˜å åŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.33</div>
                        <div class="changelog-desc">ä¼˜åŒ–è·¯å¾„æ˜¾ç¤ºæ ¼å¼ï¼ˆæ•°ç»„æ˜¾ç¤ºä¸º [index]ï¼‰å¹¶æ”¯æŒå¤åˆ¶å®Œæ•´è·¯å¾„ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.32</div>
                        <div class="changelog-desc">æ–°å¢ Key æ‚¬æµ®æç¤ºï¼šé¼ æ ‡æ‚¬åœåœ¨ Key ä¸Šæ—¶æ˜¾ç¤ºå®Œæ•´çš„çˆ¶çº§è·¯å¾„ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.31</div>
                        <div class="changelog-desc">ç¼–è¾‘æ¨¡å¼å¢åŠ â€œæ’¤é”€â€å’Œâ€œé‡åšâ€åŠŸèƒ½æ”¯æŒã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.30</div>
                        <div class="changelog-desc">ä¿®å¤ç¼–è¾‘æ¡†å®šä½é—®é¢˜ï¼šæ‰“å¼€ç¼–è¾‘æ¡†æ—¶é”šå®šæ˜¾ç¤ºæœ€å‰ç«¯å†…å®¹ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.29</div>
                        <div class="changelog-desc">æ–°å¢â€œåˆ é™¤é”®å€¼å¯¹â€åŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.28</div>
                        <div class="changelog-desc">æ–°å¢â€œå¤åˆ¶é”®ï¼ˆKeyï¼‰â€åŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.27</div>
                        <div class="changelog-desc">è°ƒæ•´åŠŸèƒ½æŒ‰é’®é¡ºåºä¸ºï¼šâ€œå¤åˆ¶å€¼â€ã€â€œå¤åˆ¶é”®å€¼å¯¹â€ã€â€œæ–°å¢å±æ€§â€ã€â€œç¼–è¾‘â€ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.26</div>
                        <div class="changelog-desc">è°ƒæ•´ç¼–è¾‘æ¡†â€œå–æ¶ˆâ€å’Œâ€œä¿å­˜â€æŒ‰é’®ä½ç½®è‡³å·¦ä¸‹è§’ï¼Œé˜²æ­¢æº¢å‡ºå±å¹•ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.25</div>
                        <div class="changelog-desc">ä¼˜åŒ–ç¼–è¾‘ä½“éªŒï¼šç¼–è¾‘æ¡†é«˜åº¦æ ¹æ®å†…å®¹é«˜åº¦è‡ªåŠ¨é€‚åº”ï¼Œè§£å†³å†…å®¹è¿‡å¤šæ—¶ç¼–è¾‘æ¡†è¿‡å°çš„é—®é¢˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.24</div>
                        <div class="changelog-desc">äº¤äº’ä¼˜åŒ–ï¼šç‚¹å‡»ç¼–è¾‘æ¡†å¤–éƒ¨ç©ºç™½åŒºåŸŸå¯ç›´æ¥å–æ¶ˆç¼–è¾‘çŠ¶æ€ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.23</div>
                        <div class="changelog-desc">æ”¯æŒå¯¹ JSON å±‚çº§ç»“æ„çš„ç¼–è¾‘æ“ä½œã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.22</div>
                        <div class="changelog-desc">ä¼˜åŒ–â€œå¤åˆ¶å€¼â€åŠŸèƒ½ï¼šå½“å€¼ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œå¤åˆ¶å†…å®¹ä¸å†åŒ…å«å¤–éƒ¨å¼•å·ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.21</div>
                        <div class="changelog-desc">æ–°å¢â€œæ–°å¢å±æ€§â€åŠŸèƒ½ï¼šæ”¯æŒåœ¨ List/Map ä¸­æ’å…¥æ–°å…ƒç´ ï¼ˆè‡ªåŠ¨ç”Ÿæˆ key åï¼‰ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.20</div>
                        <div class="changelog-desc">æ ¼å¼åŒ–åçš„è§†å›¾é¡µé¢æ”¯æŒç›´æ¥ç¼–è¾‘å†…å®¹ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.19</div>
                        <div class="changelog-desc">ä¼˜åŒ–è¡Œå·çš„ UI å±•ç¤ºæ ·å¼ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.18</div>
                        <div class="changelog-desc">ç§»é™¤è§†è§‰å¹²æ‰°çš„ç«–çº¿æ ·å¼ã€‚</div>
                    </div>
                </div>

                <div class="changelog-date-group">
                    <div class="changelog-date">2026å¹´1æœˆ6æ—¥</div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.17</div>
                        <div class="changelog-desc">ä¼˜åŒ–å±‚çº§é«˜äº®é€»è¾‘ï¼šä»…åœ¨é¼ æ ‡æ‚¬åœæ—¶é«˜äº®å½“å‰çº§åŠå…¶çˆ¶çº§ï¼Œå­çº§èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.16</div>
                        <div class="changelog-desc">æ¢å¤è¡Œå·æ˜¾ç¤ºåŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.15</div>
                        <div class="changelog-desc">ä¼˜åŒ–â€œä¿®å¤ JSONâ€åŠŸèƒ½çš„é€»è¾‘ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.14</div>
                        <div class="changelog-desc">ä¿®å¤â€œå¤åˆ¶é”®å€¼å¯¹â€åŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.13</div>
                        <div class="changelog-desc">è°ƒæ•´å¹¶å‡å°‘ç¼©è¿›å®½åº¦ï¼ŒèŠ‚çœç©ºé—´ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.12</div>
                        <div class="changelog-desc">ä¼˜åŒ–ä¸åŒå±‚çº§çš„èƒŒæ™¯è‰²æ˜¾ç¤ºæ•ˆæœã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.11</div>
                        <div class="changelog-desc">ä¸ºä¸åŒçš„ JSON å±‚çº§æ·»åŠ åŒºåˆ†èƒŒæ™¯è‰²ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.10</div>
                        <div class="changelog-desc">ä¿®å¤æ“ä½œæŒ‰é’®ä½ç½®å¼‚å¸¸è·³åŠ¨çš„é—®é¢˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.09</div>
                        <div class="changelog-desc">ä¿®æ­£â€œæ ¼å¼åŒ–â€æŒ‰é’®çš„èƒŒæ™¯è‰²ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.08</div>
                        <div class="changelog-desc">ç§»é™¤â€œåŸåºâ€åŠŸèƒ½ï¼›ä¿®å¤â€œå‹ç¼©â€åŠŸèƒ½çš„é¡ºåºé€»è¾‘é”™è¯¯ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.07</div>
                        <div class="changelog-desc">ç§»é™¤â€œåŸç æ¨¡å¼â€å’Œâ€œè§†å›¾æ¨¡å¼â€åˆ‡æ¢åŠŸèƒ½ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.06</div>
                        <div class="changelog-desc">åˆå¹¶åŸæœ‰çª—å£å¸ƒå±€ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.05</div>
                        <div class="changelog-desc">ä¿®å¤â€œè¿˜åŸâ€å›¾æ ‡æ˜¾ç¤ºå¼‚å¸¸çš„é—®é¢˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.04</div>
                        <div class="changelog-desc">çª—å£æ”¯æŒæœ€å¤§åŒ–ï¼Œå¹¶æ”¯æŒæ‹–åŠ¨è°ƒæ•´è¾“å…¥/è¾“å‡ºçª—å£çš„æ¯”ä¾‹ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.03</div>
                        <div class="changelog-desc">ä¿®å¤å†…å®¹è¿‡é•¿æ—¶çš„é¡µé¢å±•ç¤ºæº¢å‡ºé—®é¢˜ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.02</div>
                        <div class="changelog-desc">ä¿®å¤æ¢è¡ŒåŠŸèƒ½çš„ Bugã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.01</div>
                        <div class="changelog-desc">ä¿®å¤ç¼©è¿›å’Œæ¢è¡Œæ˜¾ç¤ºå¼‚å¸¸ï¼›å°†è¡Œå·å›ºå®šæ˜¾ç¤ºåœ¨æœ€å·¦ä¾§ã€‚</div>
                    </div>
                    <div class="changelog-entry">
                        <div class="changelog-version">V1.00</div>
                        <div class="changelog-desc">ä¼˜åŒ–ä»£ç ç¼©è¿›é€»è¾‘ã€‚</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputArea = document.getElementById('json-input');
        const outputDiv = document.getElementById('json-output');
        const errorMsg = document.getElementById('error-msg');

        const viewSource = document.getElementById('view-source');
        const viewTree = document.getElementById('view-tree');
        const treeToolbar = document.getElementById('tree-toolbar');

        let currentObj = null;
        let isTreeMode = false;
        let sourceDirty = false; // Flag to defer expensive stringification

        // Undo/Redo
        const historyStack = [];
        let historyIndex = -1;
        let isInputting = false;

        saveState();

        inputArea.addEventListener('input', () => {
            if (!isInputting) {
                isInputting = true;
                setTimeout(() => {
                    saveState();
                    isInputting = false;
                }, 500);
            }
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
        });

        let tooltipTimer;
        function updateTooltipPos(e) {
            const tooltip = document.getElementById('path-tooltip');
            if (!tooltip) return;
            // Slightly offset from cursor
            tooltip.style.left = (e.clientX + 10) + 'px';
            tooltip.style.top = (e.clientY + 10) + 'px';
        }

        const tooltipEl = document.getElementById('path-tooltip');
        tooltipEl.onmouseenter = () => clearTimeout(tooltipTimer);
        tooltipEl.onmouseleave = () => tooltipEl.style.display = 'none';

        function saveState() {
            const val = inputArea.value;
            if (historyIndex >= 0 && historyStack[historyIndex] === val) return;
            if (historyIndex < historyStack.length - 1) historyStack.splice(historyIndex + 1);
            historyStack.push(val);
            historyIndex++;
        }

        function syncToInput() {
            if (currentObj !== null) {
                inputArea.value = JSON.stringify(currentObj, null, 4);
                sourceDirty = false;
            }
        }

        function ensureSynced() {
            if (sourceDirty) {
                syncToInput();
                saveState();
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                inputArea.value = historyStack[historyIndex];
                if (isTreeMode) parseAndRender();
            }
        }

        function redo() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                inputArea.value = historyStack[historyIndex];
                if (isTreeMode) parseAndRender();
            }
        }

        // --- Modal Control ---
        function showChangelog() {
            document.getElementById('changelog-modal').style.display = 'flex';
        }

        function closeChangelog() {
            document.getElementById('changelog-modal').style.display = 'none';
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('changelog-modal');
            if (event.target == modal) {
                closeChangelog();
            }
        };

        // --- View Switching Logic ---
        function switchMode(mode) {
            const treeBtns = document.querySelectorAll('.tree-only');

            if (mode === 'source') {
                isTreeMode = false;
                viewSource.classList.add('active');
                viewTree.classList.remove('active');

                // Disable tree-only buttons, but keep toolbar visible for layout stability
                treeBtns.forEach(btn => btn.disabled = true);
            } else {
                // To Tree
                isTreeMode = true;
                viewSource.classList.remove('active');
                viewTree.classList.add('active');

                // Enable tree-only buttons
                treeBtns.forEach(btn => btn.disabled = false);
            }
        }

        function showEditor() {
            ensureSynced();
            switchMode('source');
        }

        function handleFormat() {
            // If we are in tree mode and have dirty data, re-render from object instead of input
            if (isTreeMode && sourceDirty) {
                reRenderTree();
                ensureSynced();
                showToast("åŒæ­¥æ ¼å¼åŒ–æˆåŠŸ âœ…");
                return;
            }

            if (parseAndRender()) {
                switchMode('tree');
                showToast("æ ¼å¼åŒ–æˆåŠŸ âœ…");
            }
        }

        async function pasteAndFormat() {
            try {
                const text = await navigator.clipboard.readText();
                if (!text) {
                    showToast("å‰ªè´´æ¿ä¸ºç©º");
                    return;
                }
                inputArea.value = text;
                saveState(); // Update undo history

                // Try to format
                handleFormat();
            } catch (err) {
                showToast("è¯»å–å‰ªè´´æ¿å¤±è´¥: " + err.message);
                console.error(err);
            }
        }

        function handleMinify() {
            // Prioritize currentObj if we are in Tree Mode (to capture sorting)
            if (isTreeMode && currentObj) {
                inputArea.value = JSON.stringify(currentObj);
                saveState();
                switchMode('source');
                showToast("å‹ç¼©æˆåŠŸ (å·²ä¿ç•™æ’åº) âœ…");
                return;
            }

            const raw = inputArea.value.trim();
            if (!raw) return;
            try {
                const parsed = JSON.parse(raw);
                inputArea.value = JSON.stringify(parsed);
                saveState();
                switchMode('source');
                showToast("å‹ç¼©æˆåŠŸ âœ…");
                errorMsg.style.display = 'none';
            } catch (e) {
                showError(e);
            }
        }

        function fixJson() {
            let raw = inputArea.value.trim();
            if (!raw) return;
            try {
                raw = raw.replace(/\/\/.*$/gm, "").replace(/\/\*[\s\S]*?\*\//g, "");
                const jsonpMatch = raw.match(/^\s*[a-zA-Z_$][a-zA-Z0-9_$]*\s*\(([\s\S]*)\)\s*;?\s*$/);
                if (jsonpMatch && jsonpMatch[1]) raw = jsonpMatch[1];

                let obj;
                try {
                    const fn = new Function("return " + raw);
                    obj = fn();
                } catch (firstErr) {
                    // Failover: Try wrapping in braces (for bare key:value pairs)
                    try {
                        const fn = new Function("return {" + raw + "}");
                        obj = fn();
                    } catch (secondErr) {
                        throw firstErr; // Throw validation error from first attempt (or generic)
                    }
                }

                inputArea.value = JSON.stringify(obj, null, 4);

                saveState();
                handleFormat(); // Go to tree view
                showToast("ä¿®å¤å¹¶æ ¼å¼åŒ–æˆåŠŸ âœ…");
            } catch (e) {
                showError({ message: "ä¿®å¤å¤±è´¥: " + e.message });
            }
        }

        function clearAll() {
            inputArea.value = '';
            outputDiv.innerHTML = '';
            currentObj = null;
            switchMode('source');
            errorMsg.style.display = 'none';
        }

        function parseAndRender() {
            const raw = inputArea.value.trim();
            if (!raw) {
                // If empty, just switch but show nothing? Or stay?
                // showToast("è¯·è¾“å…¥ JSON");
                // Allow switch but it's empty
                outputDiv.innerHTML = '';
                return true;
            }
            try {
                const parsed = JSON.parse(raw);
                currentObj = parsed;
                outputDiv.innerHTML = '';
                errorMsg.style.display = 'none';

                const tree = buildTree(parsed, 0, null, true, []);
                outputDiv.appendChild(tree);
                return true;
            } catch (e) {
                showError(e);
                switchMode('source'); // Switch back to show error context
                return false;
            }
        }

        function showError(e) {
            errorMsg.textContent = "JSON é”™è¯¯: " + e.message;
            errorMsg.style.display = 'block';
        }

        function copyCurrentContent() {
            // Smart copy based on mode
            if (isTreeMode && currentObj) {
                copyText(JSON.stringify(currentObj, null, 4));
            } else {
                copyText(inputArea.value);
            }
        }



        // Sort/Order Logic (Operates on currentObj)
        function sortJson(asc) {
            if (!currentObj) return;
            currentObj = sortObject(currentObj, asc);
            reRenderTree();
            showToast(asc ? "å·²æŒ‰åœ¨å‡åºæ’åˆ—" : "å·²æŒ‰é™åºæ’åˆ—");
        }

        function reRenderTree() {
            outputDiv.innerHTML = '';
            const tree = buildTree(currentObj, 0, null, true, []);
            outputDiv.appendChild(tree);
        }

        function sortObject(obj, asc) {
            if (Array.isArray(obj)) return obj.map(item => sortObject(item, asc));
            else if (obj !== null && typeof obj === 'object') {
                const keys = Object.keys(obj).sort();
                if (!asc) keys.reverse();
                const newObj = {};
                keys.forEach(key => newObj[key] = sortObject(obj[key], asc));
                return newObj;
            }
            return obj;
        }

        // Java Conversion Logic
        function handleJavaConvert() {
            const raw = inputArea.value.trim();
            if (!raw) return;

            if (raw.startsWith('{') || raw.startsWith('[')) {
                try {
                    const obj = JSON.parse(raw);
                    const javaCode = jsonToJava(obj);
                    inputArea.value = javaCode;
                    switchMode('source');
                    saveState();
                    showToast("å·²è½¬æ¢ä¸º Java ä»£ç  âœ…");
                } catch (e) {
                    showError(e);
                }
            } else if (raw.includes('class ')) {
                try {
                    const jsonObj = javaToJson(raw);
                    inputArea.value = JSON.stringify(jsonObj, null, 4);
                    switchMode('source');
                    saveState();
                    showToast("å·²è½¬æ¢ä¸º JSON âœ…");
                } catch (e) {
                    showError({ message: "è§£æ Java å¤±è´¥: " + e.message });
                }
            } else {
                showToast("æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„ JSON æˆ– Java ä»£ç ");
            }
        }

        function jsonToJava(obj) {
            const classes = [];
            const processedClasses = new Set();

            function toClassName(key) {
                if (!key || key === 'Root') return 'Root';
                // Remove non-alphanumeric and append Type
                return key.replace(/[^a-zA-Z0-9]/g, '')
                    .replace(/^\w/, c => c.toUpperCase()) + "Type";
            }

            function generateClass(name, data) {
                if (processedClasses.has(name) || typeof data !== 'object' || data === null) return;
                processedClasses.add(name);

                let classStr = `public class ${name} {\n`;
                const fields = [];
                const methods = [];

                for (const key in data) {
                    const val = data[key];
                    let type = "Object";

                    if (val === null) {
                        type = "Object";
                    } else if (Array.isArray(val)) {
                        if (val.length > 0) {
                            const first = val[0];
                            if (typeof first === 'object' && first !== null) {
                                const subClassName = toClassName(key);
                                generateClass(subClassName, first);
                                type = `List<${subClassName}>`;
                            } else if (typeof first === 'string') {
                                type = "List<String>";
                            } else if (typeof first === 'number') {
                                type = Number.isInteger(first) ? "List<Integer>" : "List<Double>";
                            } else {
                                type = "List<Object>";
                            }
                        } else {
                            type = "List<Object>";
                        }
                    } else if (typeof val === 'object') {
                        const subClassName = toClassName(key);
                        generateClass(subClassName, val);
                        type = subClassName;
                    } else if (typeof val === 'string') {
                        type = "String";
                    } else if (typeof val === 'number') {
                        type = Number.isInteger(val) ? "Integer" : "Double";
                    } else if (typeof val === 'boolean') {
                        type = "Boolean";
                    }

                    fields.push(`    private ${type} ${key};`);

                    methods.push(`    public ${type} get${key}() {\n        return ${key};\n    }`);
                    methods.push(`    public void set${key}(${type} ${key}) {\n        this.${key} = ${key};\n    }`);
                }

                classStr += fields.join('\n') + '\n\n';
                classStr += `    public ${name}() {}\n\n`;
                classStr += methods.join('\n\n') + '\n\n';
                classStr += `}\n`;
                classes.push(classStr); // Subclasses usually defined before or after
            }

            if (Array.isArray(obj)) {
                generateClass("Root", obj[0] || {});
            } else {
                generateClass("Root", obj);
            }

            // Reorder to match user example (Subclasses first, Root last)
            const sortedClasses = classes.sort((a, b) => {
                if (a.includes("class Root")) return 1;
                if (b.includes("class Root")) return -1;
                return 0;
            });

            const header = `import java.util.List;\nimport java.util.ArrayList;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\n`;
            return header + sortedClasses.join('\n');
        }

        function javaToJson(javaCode) {
            const classes = {};
            // Match classes and their content
            const classRegex = /public\s+class\s+(\w+)\s*\{([\s\S]*?)\}/g;
            let match;
            while ((match = classRegex.exec(javaCode)) !== null) {
                const className = match[1];
                const content = match[2];
                const fields = {};
                // Improved regex to support Chinese characters, slashes, and complex types
                const fieldRegex = /private\s+([^\s]+)\s+([^\s;]+);/g;
                let fMatch;
                while ((fMatch = fieldRegex.exec(content)) !== null) {
                    const type = fMatch[1];
                    const name = fMatch[2];
                    fields[name] = type;
                }
                classes[className] = fields;
            }

            if (Object.keys(classes).length === 0) throw new Error("æœªè¯†åˆ«åˆ° Java ç±»å®šä¹‰");

            function buildObject(className, seen = new Set()) {
                if (seen.has(className)) return {}; // Prevent infinite recursion
                seen.add(className);

                const fields = classes[className];
                if (!fields) return "æ–°å€¼";

                const obj = {};
                for (const name in fields) {
                    const type = fields[name];
                    if (type === 'Integer') {
                        obj[name] = 86600; // Use dummy or identifiable values
                    } else if (type === 'Double') {
                        obj[name] = 0.0;
                    } else if (type === 'String') {
                        obj[name] = "æ–°å€¼";
                    } else if (type === 'Boolean') {
                        obj[name] = false;
                    } else if (type.startsWith('List<')) {
                        const listMatch = type.match(/List<(\w+)>/);
                        if (listMatch) {
                            const innerType = listMatch[1];
                            const basicTypes = { 'String': 'æ–°å€¼', 'Integer': 0, 'Double': 0.0, 'Boolean': false };
                            obj[name] = [basicTypes[innerType] || buildObject(innerType, new Set(seen))];
                        } else {
                            obj[name] = [];
                        }
                    } else if (classes[type]) {
                        obj[name] = buildObject(type, new Set(seen));
                    } else {
                        obj[name] = "æ–°å€¼";
                    }
                }
                return obj;
            }

            const mainClassName = classes['Root'] ? 'Root' : Object.keys(classes).pop();
            return buildObject(mainClassName);
        }


        // --- Tree Builder (Nested Block Layout) ---
        function buildTree(data, level, key, isLast, path) {
            const container = document.createElement('div');
            container.className = 'json-node expanded';

            const isObj = typeof data === 'object' && data !== null;
            if (isObj) {
                container.classList.add('object-node');
            }

            // Header Row
            const row = document.createElement('div');
            row.className = 'json-row';

            const lineNum = document.createElement('span');
            lineNum.className = 'line-num';
            row.appendChild(lineNum);

            // Content Box for Key/Value/Preview
            const contentBox = document.createElement('div');
            contentBox.className = 'content-box';

            // No manual padding-left needed anymore, handled by CSS nesting
            // contentBox.style.paddingLeft = ... 

            // Collapser or Spacer
            if (isObj && Object.keys(data).length > 0) {
                const toggle = document.createElement('span');
                toggle.className = 'collapsible-icon';
                toggle.onclick = (e) => { e.stopPropagation(); toggleNode(container); };
                contentBox.appendChild(toggle);
            } else {
                // Always add spacer for alignment (primitives, empty objects)
                const spacer = document.createElement('span');
                spacer.style.display = 'inline-block';
                spacer.style.width = '14px';
                spacer.style.marginRight = '2px';
                contentBox.appendChild(spacer);
            }

            // Key
            if (key !== null) {
                const keySpan = document.createElement('span');
                keySpan.className = 'key';
                keySpan.textContent = `"${key}"`;

                keySpan.onmouseenter = (e) => {
                    clearTimeout(tooltipTimer);
                    const tooltip = document.getElementById('path-tooltip');
                    if (path.length > 0) {
                        tooltip.innerHTML = ''; // Clear previous content
                        const plainPathParts = [];
                        let ref = currentObj;

                        path.forEach((p, idx) => {
                            const isArr = Array.isArray(ref);
                            const segmentText = isArr ? `[${p}]` : p;
                            plainPathParts.push(segmentText);

                            const segmentSpan = document.createElement('span');
                            segmentSpan.className = 'path-segment';
                            segmentSpan.textContent = segmentText;

                            // Highlight the current leaf node slightly differently but still blue
                            if (idx === path.length - 1) {
                                segmentSpan.style.fontWeight = 'bold';
                            }

                            // Click segment to scroll to that element
                            segmentSpan.onclick = (event) => {
                                event.stopPropagation();
                                const targetPath = path.slice(0, idx + 1);
                                scrollToPath(targetPath);
                            };

                            tooltip.appendChild(segmentSpan);

                            if (idx < path.length - 1) {
                                const sep = document.createElement('span');
                                sep.className = 'separator';
                                sep.textContent = '>';
                                tooltip.appendChild(sep);
                            }
                            ref = ref[p];
                        });

                        const copyBtn = document.createElement('span');
                        copyBtn.className = 'path-copy-btn';
                        copyBtn.textContent = 'ç‚¹å‡»å¤åˆ¶å®Œæ•´è·¯å¾„';
                        copyBtn.onclick = (event) => {
                            event.stopPropagation();
                            copyText(plainPathParts.join(' > '));
                            tooltip.style.display = 'none';
                        };
                        tooltip.appendChild(copyBtn);

                        tooltip.style.display = 'block';
                        updateTooltipPos(e);
                    }
                };
                keySpan.onmouseleave = () => {
                    tooltipTimer = setTimeout(() => {
                        document.getElementById('path-tooltip').style.display = 'none';
                    }, 200);
                };

                // Single click to edit key
                keySpan.onclick = (e) => { e.stopPropagation(); handleEditKey(keySpan, path, key); };

                contentBox.appendChild(keySpan);

                const colon = document.createElement('span');
                colon.className = 'punctuation';
                colon.textContent = ': ';
                contentBox.appendChild(colon);
            }

            // Value or Opening Bracket
            if (isObj) {
                const isArr = Array.isArray(data);
                const keys = Object.keys(data);
                const count = keys.length;
                const typeLabel = isArr ? 'Array' : 'Object';

                const open = document.createElement('span');
                open.className = 'punctuation';
                open.textContent = isArr ? '[' : '{';
                open.style.cursor = 'pointer';
                open.ondblclick = (e) => { e.stopPropagation(); toggleNode(container); };
                contentBox.appendChild(open);

                if (count > 0) {
                    // Preview (when collapsed or even expanded for info)
                    // For block layout, maybe only show count when collapsed? 
                    // Or standard "Array(5)" style. Let's keep existing logic.
                    const preview = document.createElement('span');
                    preview.className = 'preview-text';
                    preview.textContent = `${typeLabel}(${count})`;
                    preview.title = "ç‚¹å‡»å±•å¼€";
                    preview.onclick = (e) => { e.stopPropagation(); toggleNode(container); };
                    contentBox.appendChild(preview);

                    // If collapsed, show closing bracket here
                    const closeCollapsed = document.createElement('span');
                    closeCollapsed.className = 'punctuation preview-text';
                    closeCollapsed.style.marginLeft = '0';
                    closeCollapsed.textContent = isArr ? ']' : '}';
                    closeCollapsed.onclick = (e) => { e.stopPropagation(); toggleNode(container); };
                    contentBox.appendChild(closeCollapsed);
                } else {
                    const closeEmpty = document.createElement('span');
                    closeEmpty.className = 'punctuation';
                    closeEmpty.textContent = isArr ? ']' : '}';
                    contentBox.appendChild(closeEmpty);
                }
            } else {
                contentBox.appendChild(createValueSpan(data, path));
            }

            // Comma (if not last)
            // Note: For block layout, usually the comma is after the closing bracket of the block.
            // But if we put the comma in the Header row for values, that works.
            // For Objects, we need to handle comma after the footer. 
            // Let's attach comma to the container or footer?
            // Existing logic puts comma in contentBox. For primitives this is fine.
            // For objects, verify where it goes.

            if (!isObj && !isLast) {
                const comma = document.createElement('span');
                comma.className = 'punctuation';
                comma.textContent = ',';
                contentBox.appendChild(comma);
            }

            // Actions (Copy Val etc)
            const actions = document.createElement('div');
            actions.className = 'action-group';

            if (key !== null) {
                const btnKey = document.createElement('button');
                btnKey.className = 'tiny-btn';
                btnKey.textContent = 'å¤åˆ¶é”®';
                btnKey.onclick = (e) => {
                    e.stopPropagation();
                    copyText(key);
                };
                actions.appendChild(btnKey);
            }

            const btnVal = document.createElement('button');
            btnVal.className = 'tiny-btn';
            btnVal.textContent = 'å¤åˆ¶å€¼';
            btnVal.onclick = (e) => {
                e.stopPropagation();
                copyText(typeof data === 'string' ? data : JSON.stringify(data, null, 2));
            };
            actions.appendChild(btnVal);

            if (key !== null) {
                const btnPair = document.createElement('button');
                btnPair.className = 'tiny-btn';
                btnPair.textContent = 'å¤åˆ¶é”®å€¼å¯¹';
                btnPair.onclick = (e) => {
                    e.stopPropagation();
                    const valStr = JSON.stringify(data, null, 2);
                    const pairStr = `"${key}": ${valStr}`;
                    copyText(pairStr);
                };
                actions.appendChild(btnPair);
            }

            // Add Property Button (Only for Objects/Arrays)
            if (isObj) {
                const btnAdd = document.createElement('button');
                btnAdd.className = 'tiny-btn';
                btnAdd.textContent = 'æ–°å¢å±æ€§';
                btnAdd.onclick = (e) => { e.stopPropagation(); handleAddProperty(path, Array.isArray(data)); };
                actions.appendChild(btnAdd);

                const btnFold = document.createElement('button');
                btnFold.className = 'tiny-btn';
                btnFold.textContent = 'æŠ˜å å­æ ‘';
                btnFold.onclick = (e) => {
                    e.stopPropagation();
                    const nStr = prompt("è¯·è¾“å…¥æ•°å­—Nï¼Œä»å½“å‰å±‚çº§å¼€å§‹å°†å…¶æ·±åº¦Nå±‚ä»¥ä¸Šçš„å­æ ‘å…¨éƒ¨æŠ˜å ");
                    if (nStr !== null) {
                        const n = parseInt(nStr);
                        if (!isNaN(n)) {
                            handleFoldSubtree(container, n);
                        }
                    }
                };
                actions.appendChild(btnFold);

                const btnEdit = document.createElement('button');
                btnEdit.className = 'tiny-btn';
                btnEdit.textContent = 'ç¼–è¾‘å€¼';
                btnEdit.onclick = (e) => { e.stopPropagation(); handleEditSubtree(container, path, data); };
                actions.appendChild(btnEdit);
            }

            if (path.length > 0) {
                const btnDelete = document.createElement('button');
                btnDelete.className = 'tiny-btn';
                btnDelete.style.color = '#cf222e';
                btnDelete.textContent = key !== null ? 'åˆ é™¤é”®å€¼å¯¹' : 'åˆ é™¤å€¼';
                btnDelete.onclick = (e) => {
                    e.stopPropagation();
                    handleDelete(path);
                };
                actions.appendChild(btnDelete);
            }

            contentBox.appendChild(actions);
            row.appendChild(contentBox);
            container.appendChild(row);

            // Children (if object & not empty)
            if (isObj && Object.keys(data).length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'json-children';

                const keys = Object.keys(data);
                keys.forEach((k, i) => {
                    const nextKey = Array.isArray(data) ? null : k;
                    const childNode = buildTree(data[k], level + 1, nextKey, i === keys.length - 1, [...path, k]);
                    childrenDiv.appendChild(childNode);
                });

                container.appendChild(childrenDiv);

                // Footer Row (Closing Bracket)
                const closeRow = document.createElement('div');
                closeRow.className = 'json-row close-bracket-row';

                const closeLineNum = document.createElement('span');
                closeLineNum.className = 'line-num';
                closeRow.appendChild(closeLineNum);

                const closeContent = document.createElement('div');
                closeContent.className = 'content-box';

                // Add spacer to align closing bracket with opening
                const spacer = document.createElement('span');
                spacer.style.display = 'inline-block';
                spacer.style.width = '14px';
                spacer.style.marginRight = '2px';
                closeContent.appendChild(spacer);

                const closeSym = document.createElement('span');
                closeSym.className = 'punctuation';
                closeSym.textContent = Array.isArray(data) ? ']' : '}';
                closeContent.appendChild(closeSym);

                if (!isLast) {
                    const comma = document.createElement('span');
                    comma.className = 'punctuation';
                    comma.textContent = ',';
                    closeContent.appendChild(comma);
                }

                closeRow.appendChild(closeContent);
                container.appendChild(closeRow);
            }

            container.dataset.path = JSON.stringify(path);
            return container;
        }

        /**
         * Scrolls to a specific JSON node based on its path
         * @param {Array} targetPath 
         */
        function scrollToPath(targetPath) {
            // Ensure we are in tree mode
            if (!isTreeMode) {
                switchMode('tree');
            }

            const nodes = document.querySelectorAll('.json-node');
            const targetPathStr = JSON.stringify(targetPath);

            let targetNode = null;
            for (const node of nodes) {
                if (node.dataset.path === targetPathStr) {
                    targetNode = node;
                    break;
                }
            }

            if (targetNode) {
                // 1. Ensure all parents are expanded first
                expandParents(targetNode);

                // 2. Use a small timeout to let the DOM layout settle after expansions
                setTimeout(() => {
                    // Set a scroll margin to avoid sticking to the very top edge
                    targetNode.style.scrollMarginTop = '100px';

                    targetNode.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start',
                        inline: 'nearest'
                    });

                    // Flash effect on the header row
                    const row = targetNode.querySelector('.json-row');
                    if (row) {
                        row.style.transition = 'none';
                        row.style.backgroundColor = 'rgba(255, 255, 0, 0.6)';
                        // Force reflow
                        row.offsetHeight;
                        row.style.transition = 'background-color 1s ease-out';
                        row.style.backgroundColor = 'transparent';
                    }
                }, 50);
            }
        }

        function expandParents(node) {
            let parent = node.parentElement;
            while (parent && parent !== outputDiv) {
                if (parent.classList.contains('json-node')) {
                    parent.classList.remove('collapsed');
                    parent.classList.add('expanded');
                }
                parent = parent.parentElement;
            }
        }

        function createValueSpan(val, path) {
            const span = document.createElement('span');
            if (typeof val === 'string') {
                span.className = 'string';
                span.textContent = `"${val}"`;
            } else if (typeof val === 'number') {
                span.className = 'number';
                span.textContent = val;
            } else if (typeof val === 'boolean') {
                span.className = 'boolean';
                span.textContent = val;
            } else if (val === null) {
                span.className = 'null';
                span.textContent = 'null';
            }

            // Edit Value on click
            span.onclick = (e) => { e.stopPropagation(); handleEditValue(span, path, val); };

            return span;
        }

        function toggleNode(node) {
            node.classList.toggle('expanded');
            node.classList.toggle('collapsed');
        }

        function toggleAll(expand) {
            const nodes = document.querySelectorAll('.json-node');
            nodes.forEach(node => {
                if (node.querySelector('.collapsible-icon')) {
                    if (expand) {
                        node.classList.remove('collapsed');
                        node.classList.add('expanded');
                    } else {
                        node.classList.remove('expanded');
                        node.classList.add('collapsed');
                    }
                }
            });
        }

        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast("å¤åˆ¶æˆåŠŸ âœ…");
            } catch (err) {
                const ta = document.createElement("textarea");
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand("Copy");
                ta.remove();
                showToast("å¤åˆ¶æˆåŠŸ (å…¼å®¹) âœ…");
            }
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.textContent = msg;
            t.className = "show";
            setTimeout(() => t.className = t.className.replace("show", ""), 2000);
        }

        /**
         * è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†å®½åº¦
         */
        function setupAutoResize(input) {
            const update = () => {
                // 1. Measure width
                const temp = document.createElement('span');
                const style = window.getComputedStyle(input);
                temp.style.visibility = 'hidden';
                temp.style.position = 'absolute';
                temp.style.whiteSpace = 'pre';
                temp.style.fontFamily = style.fontFamily;
                temp.style.fontSize = style.fontSize;
                temp.style.fontWeight = style.fontWeight;
                temp.style.fontStyle = style.fontStyle;
                temp.style.letterSpacing = style.letterSpacing;

                temp.textContent = input.value || input.placeholder || ' ';
                document.body.appendChild(temp);

                const parent = input.parentElement;
                const maxWidth = parent ? parent.clientWidth - 40 : 800;
                const textWidth = temp.getBoundingClientRect().width + 20;

                document.body.removeChild(temp);

                // 2. Decide layout based on width or manual newlines
                const hasNewLine = input.value.includes('\n');
                if (textWidth > maxWidth || hasNewLine) {
                    input.style.display = 'block';
                    input.style.width = '100%';
                    input.style.marginTop = '4px';
                } else {
                    input.style.display = 'inline-block';
                    input.style.width = Math.max(100, textWidth) + 'px';
                    input.style.marginTop = '0';
                }

                // 3. Adjust height (for textarea)
                input.style.height = 'auto';
                input.style.height = (input.scrollHeight) + 'px';
            };
            input.addEventListener('input', update);
            input.addEventListener('focus', update);
            update();
        }

        /**
         * é€’å½’æ›´æ–°å­æ ‘è·¯å¾„ï¼ˆé”®é‡å‘½ååè°ƒç”¨ï¼‰
         */
        function updateDomPaths(node, oldPath, newPath) {
            node.dataset.path = JSON.stringify(newPath);
            const children = node.querySelectorAll('.json-node');
            children.forEach(child => {
                const childPath = JSON.parse(child.dataset.path);
                // æ›¿æ¢è·¯å¾„å‰ç¼€
                const newChildPath = [...newPath, ...childPath.slice(oldPath.length)];
                child.dataset.path = JSON.stringify(newChildPath);
            });
        }

        /**
         * åˆ¤æ–­æ˜¯å¦åº”è¯¥è‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆå°æ–‡ä»¶è‡ªåŠ¨ï¼Œå¤§æ–‡ä»¶æ‰‹åŠ¨ï¼‰
         */
        function shouldAutoFormat() {
            if (!currentObj) return true;
            const jsonStr = JSON.stringify(currentObj, null, 4);
            const lineCount = jsonStr.split('\n').length;
            return lineCount < 1000;
        }

        // --- Editing Logic ---

        function handleEditKey(element, path, oldKey) {
            const input = document.createElement('textarea');
            input.value = oldKey;
            input.className = 'edit-input';
            input.rows = 1;
            setupAutoResize(input);

            function commit() {
                // åŠ¨æ€è·å–æœ€æ–°è·¯å¾„
                const node = element.closest('.json-node');
                const currentPath = node ? JSON.parse(node.dataset.path) : path;

                const newKey = input.value.trim();
                if (newKey && newKey !== oldKey) {
                    const parentPath = currentPath.slice(0, -1);
                    renameKeyWithoutRerender(parentPath, oldKey, newKey);

                    // åŒæ­¥æ›´æ–° DOM è·¯å¾„ï¼ˆå…³é”®ï¼ï¼‰
                    const newPath = [...parentPath, newKey];
                    if (node) {
                        updateDomPaths(node, currentPath, newPath);
                    }

                    showToast("é”®åå·²æ›´æ–° (å±€éƒ¨æ›´æ–°) âœ…");
                    element.textContent = `"${newKey}"`;
                    // Update key edit handler for the modified element
                    element.onclick = (e) => { e.stopPropagation(); handleEditKey(element, path, newKey); };

                    // æ™ºèƒ½æ ¼å¼åŒ–ï¼šå°æ–‡ä»¶è‡ªåŠ¨åˆ·æ–°
                    if (shouldAutoFormat()) {
                        setTimeout(() => reRenderTree(), 50);
                    }
                }
                input.replaceWith(element);
            }

            input.onblur = commit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    input.replaceWith(element);
                }
            };

            element.replaceWith(input);
            input.focus();
        }

        function handleEditValue(element, path, oldVal) {
            const valStr = (typeof oldVal === 'string') ? oldVal : JSON.stringify(oldVal);
            const input = document.createElement('textarea');
            input.value = valStr;
            input.className = 'edit-input';
            input.rows = 1;
            setupAutoResize(input);

            function commit() {
                // åŠ¨æ€è·å–æœ€æ–°è·¯å¾„ï¼ˆé˜²æ­¢é”®å·²è¢«ä¿®æ”¹ï¼‰
                const node = element.closest('.json-node');
                const currentPath = node ? JSON.parse(node.dataset.path) : path;

                const raw = input.value;
                let newVal;
                try {
                    newVal = JSON.parse(raw);
                } catch (e) {
                    newVal = raw;
                }

                if (newVal !== oldVal) {
                    setValueByPathWithoutRerender(currentPath, newVal);

                    // æ™ºèƒ½æ ¼å¼åŒ–
                    if (shouldAutoFormat()) {
                        const newElement = createValueSpan(newVal, path);
                        input.replaceWith(newElement);
                        showToast("å€¼å·²æ›´æ–° (å±€éƒ¨æ›´æ–°) âœ…");
                        setTimeout(() => reRenderTree(), 50);
                    } else {
                        // å¤§æ–‡ä»¶ä¸”å€¼æ˜¯å¯¹è±¡/æ•°ç»„ï¼šæ˜¾ç¤ºé¢„è§ˆ
                        if (typeof newVal === 'object' && newVal !== null) {
                            const previewEl = document.createElement('div');
                            previewEl.className = 'string';
                            previewEl.style.whiteSpace = 'pre-wrap';
                            previewEl.style.fontStyle = 'italic';
                            previewEl.style.opacity = '0.8';
                            previewEl.style.padding = '4px 8px';
                            previewEl.style.background = 'rgba(9, 105, 218, 0.03)';
                            previewEl.style.borderRadius = '4px';
                            previewEl.style.cursor = 'pointer';
                            previewEl.style.color = '#0969da';

                            const jsonStr = JSON.stringify(newVal, null, 2);
                            const preview = jsonStr.length > 100 ? jsonStr.substring(0, 100) + '...' : jsonStr;
                            previewEl.textContent = `${preview}\n\nâ˜ï¸ ç‚¹å‡»æ­¤å¤„æˆ–ã€æ ¼å¼åŒ–ã€æŸ¥çœ‹å®Œæ•´å†…å®¹`;
                            previewEl.title = "å·²ä¿®æ”¹ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ã€æ ¼å¼åŒ–ã€åŒæ­¥";
                            previewEl.onclick = () => handleFormat();
                            input.replaceWith(previewEl);
                        } else {
                            // åŸºæœ¬ç±»å‹ï¼šæ­£å¸¸æ˜¾ç¤º
                            const newElement = createValueSpan(newVal, path);
                            input.replaceWith(newElement);
                        }
                        showToast("å€¼å·²æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ã€æ ¼å¼åŒ–ã€åŒæ­¥ âš ï¸");
                    }
                } else {
                    input.replaceWith(element);
                }
            }

            input.onblur = commit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    input.replaceWith(element);
                }
            };

            element.replaceWith(input);
            input.focus();
        }

        function setValueByPath(path, value) {
            setValueByPathWithoutRerender(path, value);
            reRenderTree();
        }

        function setValueByPathWithoutRerender(path, value) {
            if (path.length === 0) {
                currentObj = value;
            } else {
                let ref = currentObj;
                for (let i = 0; i < path.length - 1; i++) {
                    ref = ref[path[i]];
                }
                ref[path[path.length - 1]] = value;
            }
            sourceDirty = true;
        }


        function renameKey(parentPath, oldKey, newKey) {
            renameKeyWithoutRerender(parentPath, oldKey, newKey);
            reRenderTree();
        }

        function renameKeyWithoutRerender(parentPath, oldKey, newKey) {
            let parent;
            if (parentPath.length === 0) {
                parent = currentObj;
            } else {
                parent = currentObj;
                for (let i = 0; i < parentPath.length; i++) {
                    parent = parent[parentPath[i]];
                }
            }

            if (Array.isArray(parent)) return;

            const keys = Object.keys(parent);
            const newObj = {};
            keys.forEach(k => {
                if (k === oldKey) {
                    newObj[newKey] = parent[oldKey];
                } else {
                    newObj[k] = parent[k];
                }
            });

            if (parentPath.length === 0) {
                currentObj = newObj;
            } else {
                keys.forEach(k => delete parent[k]);
                Object.assign(parent, newObj);
            }

            sourceDirty = true;
        }


        function handleAddProperty(path, isArray) {
            let target = currentObj;
            for (let i = 0; i < path.length; i++) {
                target = target[path[i]];
            }

            if (isArray) {
                target.push("æ–°å€¼");
            } else {
                let i = 1;
                while (target.hasOwnProperty("æ–°å±æ€§" + i)) {
                    i++;
                }
                target["æ–°å±æ€§" + i] = "æ–°å€¼";
            }

            syncToInput();
            saveState();
            reRenderTree();
        }

        function handleEditSubtree(container, path, data) {
            // Create editor UI
            const editorDiv = document.createElement('div');
            editorDiv.className = 'subtree-editor-container';

            const textarea = document.createElement('textarea');
            textarea.className = 'subtree-textarea';
            const jsonStr = JSON.stringify(data, null, 4);
            textarea.value = jsonStr;

            // Auto-resize logic
            const lineCount = jsonStr.split('\n').length;
            const lineHeight = 20; // Approx for 13px font * 1.5
            const padding = 20;
            const minHeight = 200;
            const targetHeight = Math.max(minHeight, (lineCount * lineHeight) + padding);
            textarea.style.height = targetHeight + 'px';
            textarea.style.lineHeight = '1.5';

            // Cleanup helper to remove event listener
            const cleanup = () => {
                document.removeEventListener('click', outsideClickListener);
            };

            const outsideClickListener = (e) => {
                if (!editorDiv.contains(e.target)) {
                    cleanup();
                    try {
                        const newData = JSON.parse(textarea.value);
                        setValueByPathWithoutRerender(path, newData);

                        // æ™ºèƒ½æ ¼å¼åŒ–ï¼šå°æ–‡ä»¶ç›´æ¥æ¸²æŸ“
                        if (shouldAutoFormat()) {
                            showToast("å€¼å·²æ›´æ–° (è‡ªåŠ¨åŒæ­¥) âœ…");
                            editorDiv.replaceWith(container);
                            setTimeout(() => reRenderTree(), 50);
                            return;
                        }

                        // å¤§æ–‡ä»¶ï¼šæ˜¾ç¤ºé¢„è§ˆ
                        const previewEl = document.createElement('div');
                        previewEl.className = 'string';
                        previewEl.style.fontSpace = 'pre-wrap';
                        previewEl.style.whiteSpace = 'pre-wrap';
                        previewEl.style.fontStyle = 'italic';
                        previewEl.style.opacity = '0.8';
                        previewEl.style.padding = '4px 8px';
                        previewEl.style.background = 'rgba(9, 105, 218, 0.03)';
                        previewEl.style.borderRadius = '4px';
                        previewEl.style.marginTop = '4px';
                        previewEl.style.cursor = 'pointer';

                        const val = textarea.value;
                        if (val.length > 50000) {
                            previewEl.textContent = val.substring(0, 50000) + "\n... (å†…å®¹è¿‡å¤šï¼Œå·²æˆªæ–­é¢„è§ˆ) ...";
                        } else {
                            previewEl.textContent = val;
                        }

                        // æ™ºèƒ½æ ¼å¼åŒ–æç¤º
                        if (shouldAutoFormat()) {
                            showToast("å€¼å·²æ›´æ–° (å»¶è¿ŸåŒæ­¥) âœ…");
                            previewEl.title = "å†…å®¹å·²æ›´æ–°ï¼Œç‚¹å‡»æ­¤å¤„æˆ–ã€æ ¼å¼åŒ–ã€åŒæ­¥";
                            previewEl.onclick = () => handleFormat();
                        } else {
                            showToast("å€¼å·²æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ã€æ ¼å¼åŒ–ã€åŒæ­¥ âš ï¸");
                            previewEl.title = "å·²ä¿®æ”¹ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ã€æ ¼å¼åŒ–ã€åŒæ­¥";
                            previewEl.onclick = () => handleFormat();
                        }

                        editorDiv.replaceWith(previewEl);
                    } catch (err) {
                        editorDiv.replaceWith(container);
                    }
                }
            };

            // Delay adding the listener to avoid triggering it immediately with the current click
            setTimeout(() => {
                document.addEventListener('click', outsideClickListener);
            }, 0);

            const btnRow = document.createElement('div');
            btnRow.style.display = 'flex';
            btnRow.style.gap = '8px';
            btnRow.style.justifyContent = 'flex-start';

            const btnSave = document.createElement('button');
            btnSave.className = 'btn btn-primary';
            btnSave.textContent = 'ä¿å­˜';
            btnSave.style.padding = '4px 12px';
            btnSave.style.fontSize = '12px';

            const btnCancel = document.createElement('button');
            btnCancel.className = 'btn btn-default';
            btnCancel.textContent = 'å–æ¶ˆ';
            btnCancel.style.padding = '4px 12px';
            btnCancel.style.fontSize = '12px';

            // Refined Save Logic to handle retry
            btnSave.onclick = (e) => {
                e.stopPropagation();
                try {
                    const newData = JSON.parse(textarea.value);
                    cleanup();
                    setValueByPathWithoutRerender(path, newData);

                    // æ™ºèƒ½æ ¼å¼åŒ–ï¼šå°æ–‡ä»¶ç›´æ¥æ¸²æŸ“
                    if (shouldAutoFormat()) {
                        showToast("å€¼å·²æ›´æ–° (è‡ªåŠ¨åŒæ­¥) âœ…");
                        editorDiv.replaceWith(container);
                        setTimeout(() => reRenderTree(), 50);
                        return;
                    }

                    // å¤§æ–‡ä»¶ï¼šæ˜¾ç¤ºé¢„è§ˆ
                    const previewEl = document.createElement('div');
                    previewEl.className = 'string';
                    previewEl.style.whiteSpace = 'pre-wrap';
                    previewEl.style.fontStyle = 'italic';
                    previewEl.style.opacity = '0.8';
                    previewEl.style.padding = '4px 8px';
                    previewEl.style.background = 'rgba(9, 105, 218, 0.03)';
                    previewEl.style.borderRadius = '4px';
                    previewEl.style.marginTop = '4px';
                    previewEl.style.cursor = 'pointer';

                    const val = textarea.value;
                    if (val.length > 50000) {
                        previewEl.textContent = val.substring(0, 50000) + "\n... (å†…å®¹è¿‡å¤šï¼Œå·²æˆªæ–­é¢„è§ˆ) ...";
                    } else {
                        previewEl.textContent = val;
                    }

                    // æ™ºèƒ½æ ¼å¼åŒ–æç¤º
                    if (shouldAutoFormat()) {
                        showToast("å€¼å·²æ›´æ–° (å»¶è¿ŸåŒæ­¥) âœ…");
                        previewEl.title = "å·²ä¿®æ”¹ï¼Œç‚¹å‡»æ­¤å¤„æˆ–ã€æ ¼å¼åŒ–ã€åŒæ­¥";
                    } else {
                        showToast("å€¼å·²æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ã€æ ¼å¼åŒ–ã€åŒæ­¥ âš ï¸");
                        previewEl.title = "å·²ä¿®æ”¹ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ã€æ ¼å¼åŒ–ã€åŒæ­¥";
                    }
                    previewEl.onclick = () => handleFormat();

                    editorDiv.replaceWith(previewEl);
                } catch (e) {
                    showToast("JSON æ ¼å¼é”™è¯¯: " + e.message);
                    textarea.focus();
                }
            };

            btnCancel.onclick = (e) => {
                e.stopPropagation();
                cleanup();
                editorDiv.replaceWith(container);
            };

            btnRow.appendChild(btnCancel);
            btnRow.appendChild(btnSave);
            editorDiv.appendChild(textarea);
            editorDiv.appendChild(btnRow);

            // Replace the tree node with the editor
            container.replaceWith(editorDiv);

            // Ensure content starts at the top
            textarea.scrollTop = 0;
            textarea.setSelectionRange(0, 0);

            // Focus without jumping the page scroll
            textarea.focus({ preventScroll: true });
        }

        function handleDelete(path) {
            if (path.length === 0) {
                currentObj = null;
            } else {
                let parent = currentObj;
                for (let i = 0; i < path.length - 1; i++) {
                    parent = parent[path[i]];
                }
                const lastKey = path[path.length - 1];
                if (Array.isArray(parent)) {
                    parent.splice(parseInt(lastKey), 1);
                } else {
                    delete parent[lastKey];
                }
            }
            syncToInput();
            saveState();
            reRenderTree();
        }

        function handleFoldSubtree(container, N) {
            const allNodes = [container, ...container.querySelectorAll('.json-node')];
            allNodes.forEach(node => {
                let depth = 0;
                let cur = node;
                while (cur && cur !== container) {
                    if (cur.parentElement && cur.parentElement.closest('.json-node')) {
                        depth++;
                        cur = cur.parentElement.closest('.json-node');
                    } else {
                        break;
                    }
                }

                const icon = node.querySelector('.collapsible-icon');
                if (icon) {
                    // depth is relative to container.
                    // depth 0 is container, depth 1 is child, etc.
                    // User N=1: child (d=1) expanded, grandchild (d=2) collapsed.
                    if (depth > N) {
                        node.classList.remove('expanded');
                        node.classList.add('collapsed');
                    } else {
                        node.classList.remove('collapsed');
                        node.classList.add('expanded');
                    }
                }
            });
        }
    </script>
</body>

</html>